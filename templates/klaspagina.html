<h2>Overzicht Klassen</h2>

<div class="toolbar">
  <div class="search-form">
    <input type="search" id="klassen-zoekbalk" name="zoek" placeholder="Zoek klas of leerling..." value="{{.Zoekterm}}"
      autocomplete="off">
    <span class="search-reset" id="klassen-reset-btn">&times;</span>
  </div>
  <form action="/klas/toevoegen" method="post" class="add-form">
    <input type="text" name="naam" placeholder="Nieuwe klasnaam" required>
    <button type="submit">Klas Toevoegen</button>
  </form>
</div>

<div class="klassen-container" id="klassen-resultaten">
  <!-- AANPASSING: Gebruik $index om alleen de eerste 'details' te openen -->
  {{range $index, $klas := .Klassen}}
  <details class="klas" {{if eq $index 0}}open{{end}}>
    <summary>
      <span>{{$klas.Naam}} ({{len $klas.Leerlingen}} leerlingen)</span>
      <div class="actions">
        <form action="/klas/verwijderen/{{$klas.ID}}" method="post"
          onsubmit="return confirm('Weet u zeker dat u klas {{$klas.Naam}} en alle leerlingen wilt verwijderen?');">
          <button type="submit" class="delete">Verwijder Klas</button>
        </form>
      </div>
    </summary>
    <div class="klas-content">
      <!-- AANPASSING: Formulier om leerling toe te voegen staat nu bovenaan -->
      <form action="/leerling/toevoegen/{{$klas.ID}}" method="post" class="add-form-inline">
        <input type="text" name="naam" placeholder="Nieuwe leerling" required>
        <button type="submit">Toevoegen</button>
      </form>

      <div class="leerlingen-lijst">
        {{range $klas.Leerlingen}}
        <div class="leerling-item">
          <a href="/leerling/{{.ID}}">{{.Naam}}</a>
          <form action="/leerling/verwijderen/{{.ID}}" method="post"
            onsubmit="return confirm('Leerling {{.Naam}} verwijderen?');">
            <button type="submit" class="delete-sm">X</button>
          </form>
        </div>
        {{else}}
        <p>Geen leerlingen in deze klas gevonden die aan de zoekterm voldoen.</p>
        {{end}}
      </div>
    </div>
  </details>
  {{else}}
  <p>Geen klassen gevonden. Voeg een nieuwe klas toe om te beginnen.</p>
  {{end}}
</div>

<!-- Het JavaScript-blok blijft ongewijzigd -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('klassen-zoekbalk');
    const resetButton = document.getElementById('klassen-reset-btn');
    const resultsContainer = document.getElementById('klassen-resultaten');
    let debounceTimer;
    const performSearch = async () => {
      const query = searchInput.value;
      window.history.pushState({}, '', `/klassen?zoek=${encodeURIComponent(query)}`);
      try {
        const response = await fetch(`/klassen?zoek=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error('Netwerkrespons was niet ok.');
        const newHtml = await response.text();
        const parser = new DOMParser();
        const newDoc = parser.parseFromString(newHtml, 'text/html');
        const newResults = newDoc.getElementById('klassen-resultaten');
        if (newResults) {
          resultsContainer.innerHTML = newResults.innerHTML;
        }
      } catch (error) {
        console.error('Fout bij het ophalen van zoekresultaten:', error);
        resultsContainer.innerHTML = '<p>Er is een fout opgetreden bij het zoeken.</p>';
      }
    };
    const toggleResetButton = () => {
      resetButton.style.display = searchInput.value ? 'block' : 'none';
    };
    searchInput.addEventListener('keyup', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(performSearch, 300);
      toggleResetButton();
    });
    resetButton.addEventListener('click', () => {
      searchInput.value = '';
      toggleResetButton();
      performSearch();
    });
    toggleResetButton();
  });
</script>